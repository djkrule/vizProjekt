<!DOCTYPE html>
<meta charset="utf-8">
<script src="//d3js.org/d3.v4.min.js"></script>

<style>
  .node {
    border: solid 1px black;
    font: 14px sans-serif;
    font-weight: bold;
    color: white;
    overflow: hidden;
    position: absolute;
    text-indent: 2px;
  }

  h1,
  h2,
  h4 {
    color: #343a40;
    margin: 0px;
    font-family: sans-serif;
  }

  text {
    font-size: 14px;
    font-weight: bold;
  }
</style>

<body>
  <div id="title" style="margin: 10px;">
    <h1>Europe Population Density</h1>
  </div>
  <div id="europeTreeMap" style="width: 1100px; height: 600px; display: inline-block;">
    <script>
      //promjeni visinu charta jer se ne vidi u cijelosti
      var opacityNorth = d3.scaleLinear()
        .domain([0, 60])
        .range([.55, .9]);
      var opacityEast = d3.scaleLinear()
        .domain([0, 130])
        .range([.55, .9]);
      var opacityWest = d3.scaleLinear()
        .domain([0, 220])
        .range([.55, 1]);
      var opacitySouth = d3.scaleLinear()
        .domain([0, 400])
        .range([.55, 1]);

      var opacityAge14 = d3.scaleLinear()
        .domain([13.2, 24])
        .range([.75, 1]);
      var opacityAge24 = d3.scaleLinear()
        .domain([8.9, 18])
        .range([.75, 1]);
      var opacityAge49 = d3.scaleLinear()
        .domain([31, 40])
        .range([.65, 1]);
      var opacityAge64 = d3.scaleLinear()
        .domain([14.1, 24])
        .range([.45, 1]);
      var opacityAge79 = d3.scaleLinear()
        .domain([5.3, 17])
        .range([.45, 1]);
      var opacityAge80 = d3.scaleLinear()
        .domain([1.5, 7])
        .range([.50, 1]);

      function getCountryOpacity(d) {
        if (d.parent.data.name == "Northern Europe") {
          return opacityNorth(d.data.value[index]);
        }
        if (d.parent.data.name == "Eastern Europe") {
          return opacityEast(d.data.value[index]);
        }
        if (d.parent.data.name == "Southern Europe") {
          return opacityWest(d.data.value[index]);
        }
        if (d.parent.data.name == "Western Europe") {
          return opacitySouth(d.data.value[index]);
        }
      }

      function getAgeOpacity(d) {
        if (index == 1)
          return opacityAge14(d.data.value[index]);
        if (index == 2)
          return opacityAge24(d.data.value[index]);
        if (index == 3)
          return opacityAge49(d.data.value[index]);
        if (index == 4)
          return opacityAge64(d.data.value[index]);
        if (index == 5)
          return opacityAge79(d.data.value[index]);
        if (index == 6)
          return opacityAge80(d.data.value[index]);
      }

      'use strict';

      const margin = { top: 0, right: 0, bottom: 20, left: 10 },
        width = 1100 - margin.left - margin.right,
        height = 600 - margin.top - margin.bottom;

      var mapColors = d3.scaleOrdinal()
        .domain(["north", "east", "south", "west"])
        .range(["#016FB9", "#D91414", "#E57A08", "#198A46"]);

      const treemap = d3.treemap().size([width, height]);

      var div = d3.select("#europeTreeMap").append("div")
        .style("position", "relative")
        .style("width", (width + margin.left + margin.right) + "px")
        .style("height", (height + margin.top + margin.bottom) + "px")
        .style("left", margin.left + "px")
        .style("top", margin.top + "px");

      d3.json("euroPopulation.json", function (error, data) {
        if (error) throw error;

        var root = d3.hierarchy(data).sum(function (d) {
          if (d.value === undefined) {
            return 0;
          }
          return d.value[0];
        })

        const tree = treemap(root);

        var node = div.datum(root).selectAll(".node")
          .data(tree.leaves())
          .enter().append("div")
          .attr("class", "node")
          .style("left", (d) => d.x0 + "px")
          .style("top", (d) => d.y0 + "px")
          .style("width", (d) => Math.max(0, d.x1 - d.x0 - 1) + "px")
          .style("height", (d) => Math.max(0, d.y1 - d.y0 - 1) + "px")
          .style("background", (d) => mapColors(d.parent.data.name))
          .style("opacity", function (d) {
            return getCountryOpacity(d)
          })
          .text((d) => d.data.name + " " + d.data.value[index])
          .on("click", function (d) {
            update(d.data["fullName"])
          })
          .on("mouseover", function (d) {
            d3.select(this)
              .style("opacity", 1)
          })
          .on("mouseout", function (d) {
            d3.select(this).style("fill", function (d) { return mapColors(d.parent.data.name) })
              .style("opacity", function (d) {
                return getCountryOpacity(d)
              })
          });

        svg1.on("mouseover", function change() {
          const newValue =
            (d) => {
              if (d.value === undefined) {
                return 0;
              }
              return d.value[index];
            }


          const newRoot = d3.hierarchy(data, (d) => d.children)
            .sum(newValue);

          node.data(treemap(newRoot).leaves())
            .transition()
            .duration(1500)
            .style("left", (d) => d.x0 + "px")
            .style("top", (d) => d.y0 + "px")
            .style("width", (d) => Math.max(0, d.x1 - d.x0 - 1) + "px")
            .style("height", (d) => Math.max(0, d.y1 - d.y0 - 1) + "px")
            .style("opacity", function (d) {
              return getAgeOpacity(d)
            })
            .text((d) => d.data.name + " " + d.data.value[index])
        });
        svg1.on("mouseout", function change() {
          const newValue =
            (d) => {
              if (d.value === undefined) {
                return 0;
              }
              return d.value[0];
            }


          const newRoot = d3.hierarchy(data, (d) => d.children)
            .sum(newValue);

          node.data(treemap(newRoot).leaves())
            .transition()
            .duration(1500)
            .style("left", (d) => d.x0 + "px")
            .style("top", (d) => d.y0 + "px")
            .style("width", (d) => Math.max(0, d.x1 - d.x0 - 1) + "px")
            .style("height", (d) => Math.max(0, d.y1 - d.y0 - 1) + "px")
            .style("opacity", function (d) {
              return getCountryOpacity(d)
            })
            .text((d) => d.data.name + " " + d.data.value[index])
        });
      });
    </script>
  </div>
  <div id="barchart" style="width: 350px; height:600px; display: inline-flex;">
    <script>
      //index = 0 is population density, index from 1-6 are age groups
      var index = 0;

      // set the dimensions and margins of the graph
      var margin1 = { top: 0, right: 0, bottom: 50, left: 50 },
        width1 = 350 - margin1.left - margin1.right,
        height1 = 600 - margin1.top - margin1.bottom;

      // append the svg object to the body of the page
      var svg1 = d3.select("#barchart")
        .append("svg")
        .attr("id", "chart")
        .attr("width", width1 + margin1.left + margin1.right)
        .attr("height", height1 + margin1.top + margin1.bottom)
        .append("g")
        .attr("transform",
          "translate(" + margin1.left + "," + margin1.top + ")");

      // Initialize the X axis
      var x = d3.scaleBand()
        .range([0, width1])
        .padding(0.2);
      var xAxis = svg1.append("g")
        .attr("transform", "translate(0," + height1 + ")")

      // Initialize the Y axis
      var y = d3.scaleLinear()
        .range([height1, 0]);
      var yAxis = svg1.append("g")
        .attr("class", "myYaxis")

      // A function that create / update the plot for a given variable:
      function update(selectedVar) {
        // Parse the Data
        d3.csv("country.txt", function (data) {
          // X axis
          x.domain(data.map(function (d) {
            return d.group;
          }))
          xAxis.transition().duration(1000).call(d3.axisBottom(x))

          // Add Y axis
          y.domain([0, d3.max(data, function (d) { return +d[selectedVar] })]);
          yAxis.transition().duration(1000).call(d3.axisLeft(y));

          // variable u: map data to existing bars
          var u = svg1.selectAll("rect")
            .data(data)
          // update bars
          u
            .enter()
            .append("rect")
            .merge(u)
            .attr("id", function (d, i) { return "stupac" + i })
            .on("mouseover", function (d, i) {
              index = i + 1;
            }).on("mouseout", function (d) { index = 0 })
            .transition()
            .duration(1000)
            .attr("x", function (d) { return x(d.group); })
            .attr("y", function (d) { return y(d[selectedVar]); })
            .attr("width", x.bandwidth())
            .attr("height", function (d) { return height1 - y(d[selectedVar]); })
            .style("fill", function (d, i) {
              var barchartColors = d3.scaleOrdinal()
                .domain([0, 1, 2, 3, 4, 5])
                .range(["#277da1", "#43aa8b", "#90be6d", "#f9c74f", "#f9844a", "#f94144"]);
              return barchartColors(i);

            })
        })
      }

      // Initialize plot
      update('Europe')

    </script>
  </div>
  <div id="legend" style="margin-left: 10px;">
    <div style="width: 20px; height: 20px; background-color: #016FB9; border-radius: 50px; display: inline-block;">
    </div>
    <h2 style="display: inline-block; margin-right: 10px;">Northern Europe</h2>
    <div style="width: 20px; height: 20px; background-color: #D91414; border-radius: 50px; display: inline-block;">
    </div>
    <h2 style="display: inline-block; margin-right: 10px;">Eastern Europe</h2>
    <div style="width: 20px; height: 20px; background-color: #E57A08; border-radius: 50px; display: inline-block;">
    </div>
    <h2 style="display: inline-block; margin-right: 10px;">Southern Europe</h2>
    <div style="width: 20px; height: 20px; background-color:  #198A46; border-radius: 50px; display: inline-block;">
    </div>
    <h2 style="display: inline-block; margin-bottom: 10px;">Western Europe</h2><br>
  </div>
  <div id="info" style="margin-left: 10px; margin-top: 20px;">
    <h4 style="display: inline;">*Country values are shown in Persons per square kilometre (p/km2)
    </h4><br>
    <h4 style="display: inline;">**By clicking on country, barchart will refresh with that country age groups
    </h4><br>
    <h4 style="display: inline;">***Hovering over chart bars will show country values for each age
      group in percentages (%)
    </h4>
  </div>
</body>

</html>